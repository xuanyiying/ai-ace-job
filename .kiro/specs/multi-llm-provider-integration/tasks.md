# 多大模型厂商集成 - 实现计划

- [x] 1. 设置项目结构和核心接口
  - 创建 AI 提供商模块目录结构（providers、interfaces、config、utils）
  - 定义统一的 AIProvider 接口和相关类型定义
  - 定义 AIRequest、AIResponse、AIStreamChunk 等数据结构
  - 定义 ModelInfo、ModelConfig 等配置数据结构
  - 设置 NestJS 模块和依赖注入配置
  - _需求: 2.1, 2.3, 2.4_

- [ ] 2. 实现 OpenAI 提供商
  - 创建 OpenAI 提供商类实现 AIProvider 接口
  - 实现 call 方法调用 OpenAI API
  - 实现 stream 方法支持流式响应
  - 实现 healthCheck 方法验证连接
  - 实现 listModels 方法获取可用模型列表
  - 实现 getModelInfo 方法获取模型信息
  - _需求: 1.4, 2.2, 2.3, 2.4, 2.5, 2.6_

- [ ]\* 2.1 为 OpenAI 提供商编写属性测试
  - **属性 4: 提供商接口实现**
  - **验证: 需求 2.1, 2.2**

- [x] 3. 实现阿里千问提供商
  - 创建阿里千问提供商类实现 AIProvider 接口
  - 实现 call 方法调用千问 API
  - 实现 stream 方法支持流式响应
  - 实现 healthCheck 方法验证连接
  - 实现 listModels 方法获取可用模型列表
  - 实现 getModelInfo 方法获取模型信息
  - _需求: 1.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [ ]\* 3.1 为阿里千问提供商编写属性测试
  - **属性 1: 多提供商支持**
  - **验证: 需求 1.1**

- [ ] 4. 实现 DeepSeek 提供商
  - 创建 DeepSeek 提供商类实现 AIProvider 接口
  - 实现 call 方法调用 DeepSeek API（兼容 OpenAI 接口）
  - 实现 stream 方法支持流式响应
  - 实现 healthCheck 方法验证连接
  - 实现 listModels 方法获取可用模型列表
  - 实现 getModelInfo 方法获取模型信息
  - _需求: 1.2, 2.2, 2.3, 2.4, 2.5, 2.6_

- [ ]\* 4.1 为 DeepSeek 提供商编写属性测试
  - **属性 1: 多提供商支持**
  - **验证: 需求 1.2**

- [ ] 5. 实现 Google Gemini 提供商
  - 创建 Google Gemini 提供商类实现 AIProvider 接口
  - 实现 call 方法调用 Gemini API
  - 实现 stream 方法支持流式响应
  - 实现 healthCheck 方法验证连接
  - 实现 listModels 方法获取可用模型列表
  - 实现 getModelInfo 方法获取模型信息
  - _需求: 1.3, 2.2, 2.3, 2.4, 2.5, 2.6_

- [ ]\* 5.1 为 Google Gemini 提供商编写属性测试
  - **属性 1: 多提供商支持**
  - **验证: 需求 1.3**

- [x] 6. 实现 Ollama 提供商
  - 创建 Ollama 提供商类实现 AIProvider 接口
  - 实现 call 方法调用本地 Ollama 服务
  - 实现 stream 方法支持流式响应
  - 实现 healthCheck 方法验证连接
  - 实现 listModels 方法自动发现已安装的模型
  - 实现 getModelInfo 方法获取模型信息
  - 支持自定义 Ollama 地址和端口配置
  - _需求: 1.5, 9.1, 9.2, 9.3, 9.4, 9.6_

- [ ]\* 6.1 为 Ollama 提供商编写属性测试
  - **属性 1: 多提供商支持**
  - **验证: 需求 1.5**

- [x] 7. 实现模型配置管理
  - 创建 ModelConfigService 管理模型配置
  - 实现从环境变量读取配置
  - 实现从 YAML 配置文件读取配置
  - 实现配置验证和加载
  - 实现配置缓存和动态更新
  - 创建数据库表存储模型配置
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

- [ ]\* 7.1 为模型配置管理编写属性测试
  - **属性 9: 环境变量配置**
  - **验证: 需求 3.1**

- [ ]\* 7.2 为模型配置管理编写属性测试
  - **属性 10: YAML 配置文件支持**
  - **验证: 需求 3.2**

- [x] 8. 实现提供商工厂和初始化
  - 创建 AIProviderFactory 工厂类
  - 实现根据配置创建提供商实例
  - 实现系统启动时加载所有已配置的提供商
  - 实现提供商的健康检查
  - 实现不可用提供商的标记和处理
  - _需求: 1.6, 1.7, 3.3, 3.4_

- [ ]\* 8.1 为提供商工厂编写属性测试
  - **属性 2: 提供商初始化**
  - **验证: 需求 1.6**

- [ ]\* 8.2 为提供商工厂编写属性测试
  - **属性 3: 动态配置更新**
  - **验证: 需求 1.7**

- [x] 9. 实现提示词模板管理器
  - 创建 PromptTemplateManager 类
  - 实现模板存储和检索
  - 实现模板变量占位符支持
  - 实现模板渲染逻辑
  - 创建数据库表存储提示词模板
  - 为所有预定义场景创建提示词模板
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [ ]\* 9.1 为提示词模板管理编写属性测试
  - **属性 15: 多模板支持**
  - **验证: 需求 4.1**

- [ ]\* 9.2 为提示词模板管理编写属性测试
  - **属性 16: 预定义模板存在**
  - **验证: 需求 4.2**

- [ ]\* 9.3 为提示词模板管理编写属性测试
  - **属性 18: 模板渲染正确性**
  - **验证: 需求 4.4**

- [x] 10. 实现提示词版本管理
  - 创建 PromptVersionManager 类
  - 实现版本创建和历史保留
  - 实现版本元数据记录（修改时间、修改者、修改原因）
  - 实现版本选择和回滚
  - 实现 A/B 测试支持
  - 实现敏感信息加密存储
  - _需求: 4.7, 10.1, 10.2, 10.3, 10.4, 10.5_

- [x]\* 10.1 为提示词版本管理编写属性测试
  - **属性 53: 提示词版本创建**
  - **验证: 需求 10.1**

- [x] 11. 实现模型选择器
  - 创建 ModelSelector 类
  - 实现 ModelSelectionStrategy 接口
  - 实现 CostOptimizedStrategy（成本优先）
  - 实现 QualityOptimizedStrategy（质量优先）
  - 实现 LatencyOptimizedStrategy（速度优先）
  - 为不同场景配置选择策略
  - 实现模型选择决策日志记录
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7_

- [ ]\* 11.1 为模型选择器编写属性测试
  - **属性 22: 场景选择策略定义**
  - **验证: 需求 5.1**

- [ ]\* 11.2 为模型选择器编写属性测试
  - **属性 23: 简历解析成本优化**
  - **验证: 需求 5.2**

- [x] 12. 实现错误处理和重试机制
  - 定义 AIError 异常类和错误代码枚举
  - 创建 RetryHandler 类实现重试逻辑
  - 实现指数退避算法
  - 实现错误类型判断和重试策略
  - 实现错误转换和格式统一
  - 实现降级响应机制
  - _需求: 2.6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [ ]\* 12.1 为错误处理编写属性测试
  - **属性 29: 重试机制**
  - **验证: 需求 6.1**

- [ ]\* 12.2 为错误处理编写属性测试
  - **属性 32: 错误特定重试策略**
  - **验证: 需求 6.4**

- [x] 13. 实现成本和使用量追踪
  - 创建 UsageTracker 类
  - 实现使用记录存储
  - 创建数据库表存储使用记录
  - 实现按模型统计成本
  - 实现按场景统计成本
  - 实现按用户统计成本
  - 实现成本报告生成
  - 实现成本导出（CSV、JSON）
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

- [x]\* 13.1 为成本追踪编写属性测试
  - **属性 35: 使用量记录完整性**
  - **验证: 需求 7.1**

- [x]\* 13.2 为成本追踪编写属性测试
  - **属性 36: 成本聚合**
  - **验证: 需求 7.2**

- [x] 14. 实现性能监控
  - 创建 PerformanceMonitor 类
  - 实现性能指标记录
  - 实现平均、最大、最小响应时间计算
  - 实现成功率和失败率计算
  - 实现告警检查逻辑
  - 创建数据库表存储性能指标
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5, 8.7_

- [ ]\* 14.1 为性能监控编写属性测试
  - **属性 41: 响应时间记录**
  - **验证: 需求 8.1**

- [ ]\* 14.2 为性能监控编写属性测试
  - **属性 42: 性能指标计算**
  - **验证: 需求 8.2**

- [x] 15. 实现日志记录和查询
  - 创建 AILogger 类
  - 实现详细的调用日志记录
  - 实现错误日志记录
  - 实现重试和降级事件日志
  - 实现日志查询功能（按模型、场景、时间范围）
  - 实现日志清理机制
  - 实现敏感信息过滤
  - _需求: 11.1, 11.2, 11.3, 11.4, 11.5, 11.6_

- [ ]\* 15.1 为日志记录编写属性测试
  - **属性 58: 错误日志记录**
  - **验证: 需求 11.1**

- [ ]\* 15.2 为日志记录编写属性测试
  - **属性 62: 日志查询**
  - **验证: 需求 11.5**

- [x] 16. 实现安全性和访问控制
  - 创建 SecurityService 类
  - 实现 API 密钥加密存储
  - 实现 API 密钥轮换机制
  - 实现用户访问控制
  - 实现审计日志记录
  - 实现敏感信息不记录检查
  - _需求: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6_

- [ ]\* 16.1 为安全性编写属性测试
  - **属性 64: API 密钥加密**
  - **验证: 需求 12.1**

- [ ]\* 16.2 为安全性编写属性测试
  - **属性 65: 敏感信息不记录**
  - **验证: 需求 12.2**

- [x] 17. 创建 AI 引擎服务
  - 创建 AIEngineService 类整合所有组件
  - 实现统一的 call 方法
  - 实现统一的 stream 方法
  - 集成模型选择器
  - 集成提示词模板管理器
  - 集成错误处理和重试机制
  - 集成成本追踪
  - 集成性能监控
  - _需求: 2.1, 2.3, 2.4, 2.5, 2.6_

- [ ]\* 17.1 为 AI 引擎编写属性测试
  - **属性 5: 统一请求格式**
  - **验证: 需求 2.3**

- [ ]\* 17.2 为 AI 引擎编写属性测试
  - **属性 6: 统一响应格式**
  - **验证: 需求 2.4**

- [x] 18. 创建 API 端点
  - 创建 AIController 类
  - 实现 POST /AI/call 端点调用 AI
  - 实现 GET /AI/models 端点获取可用模型列表
  - 实现 GET /AI/cost 端点查询成本统计
  - 实现 GET /AI/performance 端点查询性能指标
  - 实现 GET /AI/logs 端点查询日志
  - 实现 POST /AI/templates 端点管理提示词模板
  - _需求: 7.5, 8.7, 11.5_

- [ ]\* 18.1 为 API 端点编写单元测试
  - 测试所有端点的请求和响应格式
  - 测试错误处理和验证

- [x] 19. 创建数据库迁移
  - 创建 Prisma 迁移脚本
  - 创建 model_configs 表
  - 创建 prompt_templates 表
  - 创建 prompt_template_versions 表
  - 创建 usage_records 表
  - 创建 performance_metrics 表
  - 创建 audit_logs 表
  - 添加必要的索引和约束
  - _需求: 3.1, 3.2, 4.1, 7.1, 8.1, 12.1_

- [x] 20. 创建配置文件示例
  - 创建 .env.example 文件包含所有 AI 提供商的配置示例
  - 创建 AI-config.example.yaml 文件包含 YAML 配置示例
  - 创建 README 文档说明如何配置各个提供商
  - _需求: 3.1, 3.2_

- [x] 21. 集成到现有 AI 引擎
  - 将新的 AI 引擎集成到现有的 AIEngine 类
  - 更新 AIEngine 使用新的 AI 提供商系统
  - 保持向后兼容性
  - 迁移现有的提示词模板到新系统
  - _需求: 1.1-1.7, 2.1-2.6_

- [ ] 22. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请提问。

- [ ]\* 23. 编写集成测试
  - 测试完整的 AI 调用流程
  - 测试模型选择和切换
  - 测试重试和降级流程
  - 测试成本和性能报告生成
  - _需求: 所有需求_

- [ ]\* 24. 编写端到端测试
  - 使用 Playwright 测试完整的用户流程
  - 测试 API 端点的完整功能
  - _需求: 所有需求_

- [ ]\* 25. 编写性能测试
  - 使用 k6 进行负载测试
  - 测试并发 AI 调用
  - 测试模型选择性能
  - _需求: 11.1_

- [ ]\* 26. 编写安全测试
  - 测试 API 密钥加密
  - 测试敏感信息不记录
  - 测试访问控制
  - _需求: 12.1-12.6_

- [ ] 27. 最终检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请提问。
