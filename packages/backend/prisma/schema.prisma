generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String             @id @default(uuid())
  email                 String             @unique
  passwordHash          String?
  username              String?
  name                  String?
  image                 String?
  role                  Role               @default(USER)
  phone                 String?
  avatarUrl             String?
  subscriptionTier      SubscriptionTier   @default(FREE)
  subscriptionExpiresAt DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  lastLoginAt           DateTime?
  isActive              Boolean            @default(true)
  emailVerified         Boolean            @default(false)
  verificationToken     String?
  resetPasswordToken    String?
  resetPasswordExpires  DateTime?
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  paddleCustomerId      String?
  paddleSubscriptionId  String?
  subscriptionProvider  String?
  status                String             @default("ACTIVE")
  avatar                String?
  accounts              Account[]
  agentSessions         AgentSession[]
  conversations         Conversation[]
  generatedPdfs         GeneratedPDF[]
  interviewSessions     InterviewSession[]
  invitationCode        InvitationCode?
  jobs                  Job[]
  messages              Message[]
  optimizations         Optimization[]
  resumes               Resume[]
  sessions              Session[]
  storages              Storage[]

  @@index([email])
  @@map("users")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  createdAt DateTime
  updatedAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

model Resume {
  id               String         @id @default(uuid())
  userId           String
  title            String
  originalFilename String?
  fileUrl          String?
  fileType         String?
  fileSize         Int?
  parsedData       Json?
  version          Int            @default(1)
  isPrimary        Boolean        @default(false)
  parseStatus      ParseStatus    @default(PENDING)
  fileMd5          String?
  extractedText    String?
  conversationId   String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  optimizations    Optimization[]
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation     Conversation?  @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, isPrimary])
  @@index([userId, fileMd5])
  @@map("resumes")
}

model Job {
  id                 String         @id @default(uuid())
  userId             String
  title              String
  company            String
  location           String?
  jobType            String?
  salaryRange        String?
  jobDescription     String
  requirements       String
  parsedRequirements Json?
  sourceUrl          String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  optimizations      Optimization[]

  @@index([userId])
  @@map("jobs")
}

model Optimization {
  id                 String              @id @default(uuid())
  userId             String
  resumeId           String
  jobId              String
  matchScore         Json?
  suggestions        Json[]
  optimizedContent   Json?
  status             OptimizationStatus  @default(PENDING)
  createdAt          DateTime            @default(now())
  completedAt        DateTime?
  generatedPdfs      GeneratedPDF[]
  interviewQuestions InterviewQuestion[]
  interviewSessions  InterviewSession[]
  job                Job                 @relation(fields: [jobId], references: [id], onDelete: Cascade)
  resume             Resume              @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resumeId])
  @@index([jobId])
  @@map("optimizations")
}

model GeneratedPDF {
  id             String       @id @default(uuid())
  userId         String
  optimizationId String
  templateId     String
  fileUrl        String
  fileSize       Int
  downloadCount  Int          @default(0)
  createdAt      DateTime     @default(now())
  expiresAt      DateTime?
  optimization   Optimization @relation(fields: [optimizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([optimizationId])
  @@map("generated_pdfs")
}

model Template {
  id            String   @id @default(uuid())
  name          String   @unique
  category      String
  description   String
  previewUrl    String
  isPremium     Boolean  @default(false)
  isActive      Boolean  @default(true)
  configuration Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@map("templates")
}

model InterviewQuestion {
  id              String       @id @default(uuid())
  optimizationId  String
  questionType    QuestionType
  question        String
  suggestedAnswer String
  tips            String[]
  difficulty      Difficulty
  createdAt       DateTime     @default(now())
  optimization    Optimization @relation(fields: [optimizationId], references: [id], onDelete: Cascade)

  @@index([optimizationId])
  @@map("interview_questions")
}

model ModelConfig {
  id                 String   @id @default(uuid())
  name               String   @unique
  provider           String
  apiKey             String
  endpoint           String?
  defaultTemperature Float    @default(0.7)
  defaultMaxTokens   Int      @default(2000)
  costPerInputToken  Float    @default(0)
  costPerOutputToken Float    @default(0)
  rateLimitPerMinute Int      @default(0)
  rateLimitPerDay    Int      @default(0)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([provider])
  @@index([isActive])
  @@map("model_configs")
}

model PromptTemplate {
  id          String                  @id @default(uuid())
  name        String
  scenario    String
  language    String                  @default("en")
  template    String
  variables   String[]
  provider    String?
  isEncrypted Boolean                 @default(false)
  version     Int                     @default(1)
  isActive    Boolean                 @default(true)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  versions    PromptTemplateVersion[]

  @@unique([name, language])
  @@index([scenario])
  @@index([language])
  @@index([provider])
  @@index([isActive])
  @@map("prompt_templates")
}

model PromptTemplateVersion {
  id             String         @id @default(uuid())
  templateId     String
  version        Int
  content        String
  variables      String[]
  author         String
  reason         String?
  isActive       Boolean        @default(false)
  createdAt      DateTime       @default(now())
  promptTemplate PromptTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, version])
  @@index([templateId])
  @@map("prompt_template_versions")
}

model UsageRecord {
  id           String   @id @default(uuid())
  userId       String
  model        String
  provider     String
  scenario     String?
  inputTokens  Int
  outputTokens Int
  cost         Float
  latency      Int
  success      Boolean
  errorCode    String?
  agentType    String?
  workflowStep String?
  timestamp    DateTime @default(now())

  @@index([userId])
  @@index([model])
  @@index([provider])
  @@index([timestamp])
  @@index([agentType])
  @@index([workflowStep])
  @@map("usage_records")
}

model PerformanceMetrics {
  id              String   @id @default(uuid())
  model           String   @unique
  provider        String
  totalCalls      Int      @default(0)
  successfulCalls Int      @default(0)
  failedCalls     Int      @default(0)
  averageLatency  Float    @default(0)
  maxLatency      Int      @default(0)
  minLatency      Int      @default(0)
  successRate     Float    @default(0)
  failureRate     Float    @default(0)
  lastUpdated     DateTime @default(now())

  @@index([provider])
  @@map("performance_metrics")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  resource  String
  userId    String?
  details   Json?
  timestamp DateTime @default(now())

  @@index([action])
  @@index([resource])
  @@index([userId])
  @@index([timestamp])
  @@map("audit_logs")
}

model AICallLog {
  id              String   @id @default(uuid())
  model           String
  provider        String
  scenario        String?
  requestContent  String?
  responseContent String?
  inputTokens     Int?
  outputTokens    Int?
  latency         Int
  success         Boolean
  errorCode       String?
  errorMessage    String?
  stackTrace      String?
  userId          String?
  timestamp       DateTime @default(now())

  @@index([model])
  @@index([provider])
  @@index([scenario])
  @@index([success])
  @@index([timestamp])
  @@index([userId])
  @@map("ai_call_logs")
}

model AIRetryLog {
  id           String   @id @default(uuid())
  model        String
  provider     String
  attempt      Int
  maxAttempts  Int
  errorCode    String?
  errorMessage String?
  timestamp    DateTime @default(now())

  @@index([model])
  @@index([provider])
  @@index([timestamp])
  @@map("ai_retry_logs")
}

model AIDegradationLog {
  id               String   @id @default(uuid())
  model            String
  provider         String
  reason           String
  fallbackModel    String?
  fallbackProvider String?
  timestamp        DateTime @default(now())

  @@index([model])
  @@index([provider])
  @@index([timestamp])
  @@map("ai_degradation_logs")
}

model Conversation {
  id            String    @id @default(uuid())
  userId        String
  title         String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastMessageAt DateTime?
  messageCount  Int       @default(0)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages      Message[]
  resumes       Resume[]

  @@index([userId])
  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  userId         String
  role           MessageRole
  content        String
  attachments    Json?
  metadata       Json?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([userId])
  @@index([conversationId, createdAt])
  @@map("messages")
}

model InvitationCode {
  id        String    @id @default(uuid())
  code      String    @unique
  isUsed    Boolean   @default(false)
  usedBy    String?   @unique
  usedAt    DateTime?
  createdBy String
  createdAt DateTime  @default(now())
  expiresAt DateTime?
  user      User?     @relation(fields: [usedBy], references: [id])

  @@index([code])
  @@index([isUsed])
  @@map("invitation_codes")
}

model SystemSettings {
  id                       String   @id @default(uuid())
  siteName                 String   @default("AI Resume Assistant")
  siteDescription          String   @default("AI-powered resume optimization platform")
  maintenanceMode          Boolean  @default(false)
  allowRegistration        Boolean  @default(true)
  requireEmailVerification Boolean  @default(false)
  requireInviteCode        Boolean  @default(false)
  sessionTimeout           Int      @default(30)
  maxLoginAttempts         Int      @default(5)
  lockoutDuration          Int      @default(15)
  smtpHost                 String   @default("")
  smtpPort                 Int      @default(587)
  smtpUser                 String   @default("")
  smtpPassword             String   @default("")
  fromEmail                String   @default("")
  fromName                 String   @default("AI Resume Assistant")
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@map("system_settings")
}

model Storage {
  id           String   @id @default(uuid())
  userId       String
  filename     String
  originalName String
  fileSize     Int
  mimeType     String
  fileUrl      String
  filePath     String
  hashMd5      String
  fileType     FileType
  category     String?
  thumbnailUrl String?
  ossType      OssType
  isPublic     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([fileType])
  @@index([hashMd5])
  @@map("storages")
}

model InterviewSession {
  id             String             @id @default(uuid())
  userId         String
  optimizationId String
  status         InterviewStatus    @default(IN_PROGRESS)
  startTime      DateTime           @default(now())
  endTime        DateTime?
  score          Int?
  feedback       String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  messages       InterviewMessage[]
  optimization   Optimization       @relation(fields: [optimizationId], references: [id], onDelete: Cascade)
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([optimizationId])
  @@map("interview_sessions")
}

model InterviewMessage {
  id        String           @id @default(uuid())
  sessionId String
  role      MessageRole
  content   String
  audioUrl  String?
  createdAt DateTime         @default(now())
  session   InterviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("interview_messages")
}

model AgentSession {
  id          String    @id @default(cuid())
  userId      String
  agentType   String
  status      String
  input       Json?
  output      Json?
  tokenUsage  Json?
  cost        Float     @default(0)
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([agentType])
  @@index([status])
  @@index([startedAt])
  @@map("agent_sessions")
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

enum Role {
  USER
  ADMIN
}

enum ParseStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum OptimizationStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum QuestionType {
  BEHAVIORAL
  TECHNICAL
  SITUATIONAL
  RESUME_BASED
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum FileType {
  IMAGE
  VIDEO
  DOCUMENT
  AUDIO
  OTHER
}

enum OssType {
  MINIO
  AWS_S3
  ALIYUN_OSS
  TENCENT_COS
  LOCAL
}

enum InterviewStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}
